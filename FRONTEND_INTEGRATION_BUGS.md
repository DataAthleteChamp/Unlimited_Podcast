# ğŸ› Frontend Integration Bugs & Fixes

## Problem Summary

The frontend (`endlesspodcast`) and backend (`Unlimited_Podcast`) are **NOT connected**. The frontend was generated by Lovable with Supabase integration, but it needs to be rewired to talk to your Python FastAPI backend.

---

## ğŸ” Bugs Found

### Bug #1: Frontend Uses Supabase, Not Python Backend âŒ

**Location**: `endlesspodcast/src/integrations/supabase/client.ts`

**Issue**:
```typescript
// Frontend is configured for Supabase
export const supabase = createClient<Database>(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY);
```

**Impact**: All data operations go to Supabase database, not your Python API.

**Fix**: Create API client for Python backend âœ… **FIXED** - Created `src/lib/api.ts`

---

### Bug #2: Hardcoded Mock Data âŒ

**Location**: `endlesspodcast/src/pages/Index.tsx` (lines 10-26)

**Issue**:
```typescript
const topics = [
  { id: 1, title: "AI & Creativity", description: "..." },
  { id: 2, title: "Ethics in Tech", description: "..." },
  { id: 3, title: "Future of Design", description: "..." },
];
```

**Impact**: Topics are hardcoded in frontend, not fetched from backend API.

**Expected**:
```typescript
// Should fetch from: GET http://localhost:8000/api/topics
const { data: topics } = useQuery(['topics'], () => api.getTopics());
```

**Fix**: Update Index.tsx to use `api.getTopics()` (needs to be done)

---

### Bug #3: No Backend API Calls âŒ

**Location**: Throughout frontend components

**Issue**: No `fetch()` or `axios` calls to `http://localhost:8000`

**Search Results**:
```bash
$ grep -r "fetch\|axios" src/
# Result: No API calls found
```

**Fix**: Created `src/lib/api.ts` with full API client âœ…

---

### Bug #4: Chat Sidebar Uses Local State Only âŒ

**Location**: `endlesspodcast/src/components/ChatSidebar.tsx`

**Issue**:
```typescript
const [messages, setMessages] = useState<Message[]>([]);

const handleSend = () => {
  const newMessage: Message = { /* ... */ };
  setMessages([...messages, newMessage]); // Only local state!
};
```

**Impact**: Messages are NOT sent to backend, not saved, not visible to other users.

**Expected**:
```typescript
const handleSend = async () => {
  await api.sendChatMessage(username, inputValue);
  // Backend will broadcast via SSE
};
```

**Fix**: Update ChatSidebar.tsx to call `api.sendChatMessage()` (needs to be done)

---

### Bug #5: No SSE (Real-Time Updates) âŒ

**Location**: Missing throughout frontend

**Issue**: No Server-Sent Events connection for real-time updates

**Expected**: Frontend should connect to `http://localhost:8000/api/stream`

**Backend SSE Events**:
- `TOPICS_UPDATED` - When topics change
- `NOW_PLAYING` - When podcast plays audio
- `TRANSCRIPT_UPDATE` - When dialogue is added
- `CHAT_MESSAGE` - When someone chats

**Fix**: Created `src/hooks/useSSE.ts` âœ…

---

### Bug #6: Environment Variable Not Used âŒ

**Location**: `endlesspodcast/.env`

**Issue**:
```bash
# Added but NEVER used in code
VITE_API_URL=http://localhost:8000
```

**Fix**: API client now uses it âœ…
```typescript
const API_URL = import.meta.env.VITE_API_URL || 'http://localhost:8000';
```

---

### Bug #7: No TypeScript Types for Backend Models âŒ

**Location**: Missing type definitions

**Issue**: Frontend doesn't have types matching backend models

**Backend Models** (from `backend/models/`):
- `Topic` - with id, text, nickname, votes, reactions, score
- `ChatMessage` - with nickname, message, is_ai, persona
- `PodcastStatus` - with running, turn_number, current_topic_id
- `TranscriptEntry` - with speaker, text, turn_number

**Fix**: Created types in `src/lib/api.ts` âœ…

---

## âœ… What Was Fixed

### 1. Created API Client âœ…

**File**: `endlesspodcast/src/lib/api.ts`

**Features**:
- Full TypeScript client for Python backend
- All endpoints implemented:
  - Topics: `getTopics()`, `createTopic()`, `voteTopic()`, `reactToTopic()`
  - Podcast: `startPodcast()`, `stopPodcast()`, `getPodcastStatus()`, `getNowPlaying()`
  - Chat: `getChatMessages()`, `sendChatMessage()`
  - SSE: `createEventSource()`
- Uses `VITE_API_URL` environment variable
- Proper error handling

### 2. Created SSE Hook âœ…

**File**: `endlesspodcast/src/hooks/useSSE.ts`

**Features**:
- React hook for Server-Sent Events
- Auto-reconnect on disconnect
- Event handlers for all 4 event types
- Connection status tracking

---

## ğŸš§ What Still Needs to Be Done

### Step 1: Update Index.tsx to Fetch Topics

**Current** (hardcoded):
```typescript
const topics = [/* hardcoded array */];
```

**Change to**:
```typescript
import { useQuery } from '@tanstack/react-query';
import { api } from '@/lib/api';

const { data: topics = [], isLoading, refetch } = useQuery({
  queryKey: ['topics'],
  queryFn: () => api.getTopics(),
  refetchInterval: 5000, // Refresh every 5 seconds
});
```

**Also add SSE to auto-refresh**:
```typescript
useSSE({
  onTopicsUpdated: () => {
    refetch(); // Refresh topics when updated
  },
  autoConnect: true,
});
```

### Step 2: Update TopicCard to Call Backend

**Add vote handler**:
```typescript
const handleVote = async (topicId: string) => {
  try {
    await api.voteTopic(topicId, 1);
    toast.success('Voted!');
  } catch (error) {
    toast.error('Failed to vote');
  }
};
```

**Add reaction handler**:
```typescript
const handleReact = async (topicId: string, emoji: 'ğŸ‘' | 'ğŸ‘') => {
  try {
    await api.reactToTopic(topicId, emoji);
    toast.success(`Reacted with ${emoji}`);
  } catch (error) {
    toast.error('Failed to react');
  }
};
```

### Step 3: Update ChatSidebar to Use Backend

**Change handleSend**:
```typescript
const handleSend = async () => {
  if (!inputValue.trim()) return;

  try {
    await api.sendChatMessage(username, inputValue);
    setInputValue("");
    // Message will appear via SSE
  } catch (error) {
    toast.error('Failed to send message');
  }
};
```

**Add SSE listener**:
```typescript
useSSE({
  onChatMessage: (data) => {
    const newMessage: Message = {
      id: messages.length + 1,
      text: data.message,
      sender: data.is_ai ? 'ai' : 'user',
      timestamp: new Date(data.timestamp),
      username: data.nickname,
    };
    setMessages(prev => [...prev, newMessage]);
  },
});
```

**Fetch initial messages**:
```typescript
useEffect(() => {
  api.getChatMessages().then(msgs => {
    const formattedMessages = msgs.map((msg, idx) => ({
      id: idx + 1,
      text: msg.message,
      sender: msg.is_ai ? 'ai' : 'user',
      timestamp: new Date(msg.timestamp),
      username: msg.nickname,
    }));
    setMessages(formattedMessages);
  });
}, []);
```

### Step 4: Add Podcast Controls

**Create new component**: `src/components/PodcastControls.tsx`

```typescript
import { useState, useEffect } from 'react';
import { Button } from '@/components/ui/button';
import { api } from '@/lib/api';
import { Play, Pause } from 'lucide-react';

export function PodcastControls() {
  const [isRunning, setIsRunning] = useState(false);

  useEffect(() => {
    // Check status on mount
    api.getPodcastStatus().then(status => {
      setIsRunning(status.running);
    });
  }, []);

  const handleToggle = async () => {
    try {
      if (isRunning) {
        await api.stopPodcast();
      } else {
        await api.startPodcast();
      }
      setIsRunning(!isRunning);
    } catch (error) {
      console.error('Failed to toggle podcast:', error);
    }
  };

  return (
    <Button onClick={handleToggle} size="lg">
      {isRunning ? <Pause className="mr-2" /> : <Play className="mr-2" />}
      {isRunning ? 'Stop Podcast' : 'Start Podcast'}
    </Button>
  );
}
```

### Step 5: Add Audio Player for Podcast

**Update AgentAvatar to play audio**:

Use SSE `NOW_PLAYING` event to get audio URL and play it:

```typescript
useSSE({
  onNowPlaying: (data) => {
    const audioUrl = `http://localhost:8000${data.audio_url}`;
    const audio = new Audio(audioUrl);
    audio.play();

    // Update active speaker
    setActiveSpeaker(data.speaker);
  },
});
```

---

## ğŸ“‹ Step-by-Step Integration Checklist

- [x] 1. Create API client (`src/lib/api.ts`) âœ…
- [x] 2. Create SSE hook (`src/hooks/useSSE.ts`) âœ…
- [ ] 3. Update Index.tsx to fetch topics from backend
- [ ] 4. Update TopicCard to vote/react via backend
- [ ] 5. Update ChatSidebar to send/receive messages
- [ ] 6. Add PodcastControls component
- [ ] 7. Add audio playback for podcast
- [ ] 8. Add transcript display component
- [ ] 9. Test full integration
- [ ] 10. Deploy both repos

---

## ğŸ§ª Testing the Integration

### Test 1: Topics

1. **Backend**: Create topic via curl or API docs
2. **Frontend**: Should appear automatically (via SSE)
3. **Frontend**: Create topic via UI
4. **Backend**: Check logs, should see "Creating topic"

### Test 2: Chat

1. **Frontend**: Send message via chat
2. **Backend**: Should log "Received chat message"
3. **Backend**: AI agents should respond
4. **Frontend**: AI messages should appear (via SSE)

### Test 3: Podcast

1. **Frontend**: Click "Start Podcast"
2. **Backend**: Should log "Starting podcast scheduler"
3. **Backend**: Should generate dialogue and audio every 20s
4. **Frontend**: Should play audio automatically
5. **Frontend**: Transcript should update in real-time

---

## ğŸ”§ Quick Fix Commands

### Update Frontend Dependencies

```bash
cd endlesspodcast
npm install
```

### Restart Frontend (to load new code)

```bash
# Kill current server (Ctrl+C)
# Then restart:
npm run dev
```

### Check Backend is Running

```bash
curl http://localhost:8000/health
```

---

## ğŸ Debugging Tips

### Check CORS Errors

**Symptom**: Browser console shows "blocked by CORS policy"

**Fix**: Backend `.env` already has:
```bash
CORS_ORIGINS=http://localhost:8080,http://127.0.0.1:8080
```

If still failing, restart backend.

### Check Network Tab

Open Browser DevTools â†’ Network tab:
- Should see calls to `localhost:8000/api/*`
- Should see SSE connection to `localhost:8000/api/stream`
- Status should be 200 OK

### Check Console Logs

Frontend console should show:
```
ğŸ”— API Client initialized: http://localhost:8000
ğŸ“¡ Connecting to SSE stream...
âœ… SSE connected
```

Backend logs should show:
```
INFO: 127.0.0.1:xxxx - "GET /api/topics HTTP/1.1" 200 OK
INFO: 127.0.0.1:xxxx - "GET /api/stream HTTP/1.1" 200 OK
```

---

## ğŸ“Š Current Status

| Component | Status | Notes |
|-----------|--------|-------|
| Backend API | âœ… Working | All endpoints ready |
| Backend CORS | âœ… Configured | Allows port 8080 |
| Frontend API Client | âœ… Created | `src/lib/api.ts` |
| Frontend SSE Hook | âœ… Created | `src/hooks/useSSE.ts` |
| Frontend Topics | âŒ Hardcoded | Needs update |
| Frontend Chat | âŒ Local Only | Needs update |
| Frontend Audio | âŒ Mock | Needs SSE integration |
| Frontend Controls | âŒ Missing | Needs creation |

---

## ğŸ¯ Next Steps

1. **Update Index.tsx** - Replace hardcoded topics with API calls
2. **Update ChatSidebar.tsx** - Connect to backend chat API
3. **Add PodcastControls** - Start/stop podcast from UI
4. **Add Audio Player** - Play podcast audio from SSE events
5. **Test Everything** - Full end-to-end testing

---

**Summary**: The frontend was generated with Supabase, but we've created all the integration code needed for the Python backend. Now we just need to update the UI components to use it!
